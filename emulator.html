<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Portland Galaxy | Emulator</title>
<link id="dynamic-favicon" rel="icon" href="">
<style>
  /* Base */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Orbitron', sans-serif; color: white; overflow-x: hidden; cursor: url('https://i.imgur.com/VYw4R2X.png'), auto; background: #000; }
  canvas { display: block; position: fixed; top:0; left:0; z-index:-1; }

  /* Starfield container */
  #top { text-align: center; padding: 20px; }

  /* Home button */
  .home-btn {
    display: inline-block;
    margin: 0 auto 30px auto;
    padding: 12px 25px;
    font-size: 1.1rem;
    color: white;
    background: rgba(0,0,50,0.6);
    border: 2px solid #6ec6ff;
    border-radius: 20px;
    text-decoration: none;
    text-align: center;
    width: 120px;
    transition: 0.3s;
    cursor: pointer;
  }
  .home-btn:hover {
    background: #6ec6ff;
    color: #090a0f;
    box-shadow: 0 0 20px #6ec6ff, 0 0 40px #4da6ff;
  }

  /* Upload box */
  #box {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    padding: 40px;
    max-width: 420px;
    margin: 60px auto;
    text-align: center;
    transition: all 0.3s ease;
  }
  #box:hover { transform: translateY(-3px); box-shadow: 0 18px 36px rgba(0,0,0,0.5); }
  #box[drag] { border-color: #4cafef; background-color: rgba(15,26,54,0.8); }

  input[type="file"] { display: none; }

  /* Upload label */
  label.cssbuttons-io {
    display: inline-block;
    cursor: pointer;
    margin-top: 15px;
  }

  /* Game display container */
  #display { margin: auto; padding: 20px; max-width: 95%; }

  /* Disguise button */
  .disguise-btn {
    display: inline-block;
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 1rem;
    color: white;
    background: rgba(0,0,50,0.6);
    border: 2px solid #6ec6ff;
    border-radius: 15px;
    cursor: pointer;
    transition: 0.3s;
  }
  .disguise-btn:hover {
    background: #6ec6ff;
    color: #090a0f;
    box-shadow: 0 0 20px #6ec6ff, 0 0 40px #4da6ff;
  }
</style>
</head>
<body>

<canvas id="starfield"></canvas>

<div id="top">
  <a href="index.html" class="home-btn">Home</a>
  <button class="disguise-btn" onclick="disguiseTab()">Disguise Tab</button>
</div>

<div id="box">
  <input type="file" id="input" />
 <label for="input" class="cssbuttons-io">Click To Upload ROM</label>
</div>

<script>
/* Starfield */
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');
let w = canvas.width = window.innerWidth;
let h = canvas.height = window.innerHeight;
const stars = [];
for(let i=0;i<400;i++){
  stars.push({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.5+0.5,vx:(Math.random()-0.5)*0.7,vy:(Math.random()-0.5)*0.7});
}
function animate() {
  ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#fff';
  stars.forEach(s=>{
    s.x+=s.vx; s.y+=s.vy;
    if(s.x<0)s.x=w;if(s.x>w)s.x=0;if(s.y<0)s.y=h;if(s.y>h)s.y=0;
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  });
  requestAnimationFrame(animate);
}
animate();
window.addEventListener('resize',()=>{ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; });

/* Emulator Upload Logic */
const input = document.getElementById("input");
const box = document.getElementById("box");
let enableDebug=false, enableThreads=false;
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get('debug')==='1') enableDebug=true;
if(urlParams.get('threads')==='1' && window.SharedArrayBuffer) enableThreads=true;

function createCoreSelector(ext, fileParts){
  return new Promise(resolve=>{
    const coreMap = {
      "Nintendo 64":"n64","Nintendo Game Boy":"gb","Nintendo Game Boy Advance":"gba","Nintendo DS":"nds",
      "NES":"nes","SNES":"snes","PlayStation":"psx","Virtual Boy":"vb","Sega Mega Drive":"segaMD",
      "Sega Master System":"segaMS","Sega CD":"segaCD","Atari Lynx":"lynx","Sega 32X":"sega32x","Atari Jaguar":"jaguar",
      "Sega Game Gear":"segaGG","Sega Saturn":"segaSaturn","Atari 7800":"atari7800","Atari 2600":"atari2600",
      "TurboGrafx-16/PC Engine":"pce","PC-FX":"pcfx","NeoGeo Pocket":"ngp","WonderSwan":"ws","ColecoVision":"coleco",
      "Commodore 64":"vice_x64sc","Commodore 128":"vice_x128","VIC20":"vice_xvic","Plus/4":"vice_xplus4","PET":"vice_xpet"
    };
    const select=document.createElement("select");
    const button=document.createElement("button");
    for(const [label,val] of Object.entries(coreMap)){ const opt=document.createElement("option"); opt.value=val; opt.textContent=label; select.appendChild(opt);}
    button.textContent="Load Game";
    button.onclick=()=>resolve(select.value);

    box.innerHTML=""; box.appendChild(select); box.appendChild(button);
  });
}

input.onchange = async () => {
  const file = input.files[0];
  const parts = file.name.split(".");
  const ext = parts.pop().toLowerCase();
  
  const core = await createCoreSelector(ext, parts);

  // Setup display
  const div = document.createElement("div");
  const sub = document.createElement("div");
  div.id="display"; sub.id="game";
  document.body.appendChild(div);
  div.appendChild(sub);
  box.remove();

  // Setup EJS player
  window.EJS_player="#game";
  window.EJS_gameName=parts.join(".");
  window.EJS_biosUrl="";
  window.EJS_gameUrl=file;
  window.EJS_core=core;
  window.EJS_pathtodata="data/";
  window.EJS_startOnLoaded=true;
  window.EJS_DEBUG_XX=enableDebug;
  window.EJS_disableDatabases=true;
  window.EJS_threads=enableThreads;

  const script=document.createElement("script");
  script.src="data/loader.js";
  document.body.appendChild(script);
};

/* Drag & Drop */
box.ondragover=()=>box.setAttribute("drag",true);
box.ondragleave=()=>box.removeAttribute("drag");

/* Persist Favicon & Title */
const savedTitle=localStorage.getItem('disguiseTitle');
const savedFavicon=localStorage.getItem('disguiseFavicon');
if(savedTitle) document.title=savedTitle;
if(savedFavicon) document.getElementById('dynamic-favicon').href=savedFavicon;

/* Disguise Tab */
async function disguiseTab() {
  const url = prompt("Enter a site URL to disguise tab (include https://):");
  if(!url) return;
  try {
    const response = await fetch("https://api.allorigins.win/get?url="+encodeURIComponent(url));
    const data = await response.json();
    const html = data.contents;
    const titleMatch = html.match(/<title>(.*?)<\/title>/i);
    const newTitle = titleMatch ? titleMatch[1] : "Portland Galaxy";
    const faviconUrl = new URL("/favicon.ico", url).href;

    document.title = newTitle;
    document.getElementById('dynamic-favicon').href = faviconUrl;

    localStorage.setItem('disguiseTitle', newTitle);
    localStorage.setItem('disguiseFavicon', faviconUrl);

    alert("Tab disguised!");
  } catch(err) {
    alert("Failed to fetch site data. Make sure the URL is valid and includes https://");
  }
}
</script>

</body>
</html>


